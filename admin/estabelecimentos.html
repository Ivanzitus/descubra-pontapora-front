<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cadastro de Estabelecimentos</title>
  <link href="../src/icon.png" rel="icon" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    .table-bordered th, .table-bordered td { white-space: nowrap; }
    .table-responsive { overflow-x: auto; }
  </style>
</head>
<body class="bg-light">
  <div id="header"></div>
  <div id="alertaLogin"></div>
  <div class="container py-5">
    <h2 id="form-title" class="mb-4">Cadastro de Estabelecimentos</h2>
    <form id="formCadastro" class="row g-3 needs-validation" novalidate>
      <div class="col-md-6">
        <label for="titulo" class="form-label">Título</label>
        <input type="text" class="form-control" id="titulo" required />
      </div>
      <div class="col-md-6">
        <label for="tipo" class="form-label">Tipo</label>
        <select class="form-select" id="tipo" required>
          <option value="">Selecione</option>
          <option value="Gastronomia">Gastronomia</option>
          <option value="Hotel">Hotel</option>
          <option value="Comercio">Comércio</option>
        </select>
      </div>
      <div class="col-md-6">
        <label for="subcategoria" class="form-label">Subcategoria</label>
        <select class="form-select" id="subcategoria" required>
          <option value="">Selecione</option>
          <option value="Paraguaia">Paraguaia</option>
          <option value="Eletrônicos">Eletrônicos</option>
          <option value="Perfumaria">Perfumaria</option>
        </select>
      </div>
      <div class="col-md-6">
        <label for="descricao" class="form-label">Descrição</label>
        <input type="text" class="form-control" id="descricao" />
      </div>
      <div class="col-md-6">
        <label for="endereco" class="form-label">Endereço</label>
        <input type="text" class="form-control" id="endereco" />
      </div>
      <div class="col-md-3">
        <label for="abertura" class="form-label">Abertura</label>
        <input type="time" class="form-control" id="abertura" required />
      </div>
      <div class="col-md-3">
        <label for="fechamento" class="form-label">Fechamento</label>
        <input type="time" class="form-control" id="fechamento" required />
      </div>
      <div class="col-md-6">
        <label for="localiza_lat" class="form-label">Latitude</label>
        <input type="number" step="0.0001" class="form-control" id="localiza_lat" />
      </div>
      <div class="col-md-6">
        <label for="localiza_long" class="form-label">Longitude</label>
        <input type="number" step="0.0001" class="form-control" id="localiza_long" />
      </div>
      <div class="col-md-6">
        <label for="site" class="form-label">Site</label>
        <input type="url" class="form-control" id="site" />
      </div>
      <div class="col-12">
        <button type="submit" id="btnSubmit" class="btn btn-primary">Cadastrar</button>
        <button type="button" id="btnCancelarEdicao" class="btn btn-secondary d-none" onclick="cancelarEdicao()">Cancelar</button>
      </div>
    </form>

    <div id="mensagem" class="mt-3"></div>

    <div class="d-flex justify-content-between align-items-center mt-5">
      <h3>Estabelecimentos Cadastrados</h3>
      <div>
        <label for="limite" class="form-label me-2">Itens por página:</label>
        <select id="limite" class="form-select d-inline-block w-auto">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="15">15</option>
          <option value="20">20</option>
          <option value="25">25</option>
          <option value="50">50</option>
        </select>
        <button class="btn btn-secondary ms-2" onclick="carrega_estabelecimentos()">Recarregar</button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered mt-3">
        <thead>
          <tr>
            <th>Título</th>
            <th>Tipo</th>
            <th>Subcategoria</th>
            <th>Descrição</th>
            <th>Endereço</th>
            <th>Funcionamento</th>
            <th>Latitude</th>
            <th>Longitude</th>
            <th>Site</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="tabelaEstabelecimentos"></tbody>
      </table>
    </div>
    <nav>
      <ul id="paginacao" class="pagination"></ul>
    </nav>
  </div>

  <script src="../js/header_adm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../js/config.js"></script>
  <script src="../js/utils.js"></script>
  <script>
    // Ajuste sua URL base (sem /estabelecimentos)
    const API_BASE_URL = 'http://localhost:5000/locais';

    let paginaAtual = 1;

    async function carrega_estabelecimentos() {
      const limite = +document.getElementById('limite').value;
      const resp = await fetch(`${API_BASE_URL}/estabelecimentos?pagina=${paginaAtual}&limite=${limite}`);
      if (!resp.ok) {
        exibirMensagem('Não foi possível carregar a lista.', 'danger');
        return;
      }
      const dados = await resp.json();

      const tabela = document.getElementById('tabelaEstabelecimentos');
      tabela.innerHTML = '';
      dados.estabelecimentos.forEach(est => {
        tabela.innerHTML += `
          <tr>
            <td>${est.titulo}</td>
            <td>${est.tipo}</td>
            <td>${est.subcategoria}</td>
            <td>${est.descricao||''}</td>
            <td>${est.endereco||''}</td>
            <td>${est.hra_funcionamento||''}</td>
            <td>${est.localiza_lat||''}</td>
            <td>${est.localiza_long||''}</td>
            <td>${est.site?`<a href="${est.site}" target="_blank">Link</a>`:''}</td>
            <td>
              <button class="btn btn-sm btn-warning" onclick="abrirEdicao(${est.id})">Editar</button>
              <button class="btn btn-sm btn-danger" onclick="deletarEstabelecimento(${est.id})">Excluir</button>
            </td>
          </tr>`;
      });

      renderizaPaginacao(dados.total_paginas);
    }

    function renderizaPaginacao(totalPaginas) {
      const pag = document.getElementById('paginacao');
      pag.innerHTML = '';
      for (let i = 1; i <= totalPaginas; i++) {
        pag.innerHTML += `
          <li class="page-item ${i===paginaAtual?'active':''}">
            <a class="page-link" href="#" onclick="mudarPagina(${i})">${i}</a>
          </li>`;
      }
    }

    function mudarPagina(n) {
      paginaAtual = n;
      carrega_estabelecimentos();
    }

    function limparFormulario() {
      const form = document.getElementById('formCadastro');
      form.reset();
      form.classList.remove('was-validated');
      paginaAtual = 1;
    }

    function exibirMensagem(txt, tipo='success') {
      const div = document.getElementById('mensagem');
      div.innerHTML = `<div class="alert alert-${tipo}" role="alert">${txt}</div>`;
      setTimeout(() => div.innerHTML = '', 4000);
    }

    document.getElementById('formCadastro').addEventListener('submit', async e => {
      e.preventDefault();
      const form = e.target;
      if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
      }

      const dados = {
        titulo: e.target.titulo.value.trim(),
        tipo: e.target.tipo.value,
        subcategoria: e.target.subcategoria.value,
        descricao: e.target.descricao.value.trim(),
        endereco: e.target.endereco.value.trim(),
        abertura: e.target.abertura.value,
        fechamento: e.target.fechamento.value,
        localiza_lat: parseFloat(e.target.localiza_lat.value) || null,
        localiza_long: parseFloat(e.target.localiza_long.value) || null,
        site: e.target.site.value.trim()
      };

      const resp = await fetch(`${API_BASE_URL}/estabelecimentos`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(dados)
      });

      if (resp.ok) {
        exibirMensagem('Cadastrado com sucesso!');
        limparFormulario();
        carrega_estabelecimentos();
      } else {
        exibirMensagem('Erro ao cadastrar.', 'danger');
      }
    });

    async function deletarEstabelecimento(id) {
      if (!confirm('Confirma exclusão?')) return;
      const resp = await fetch(`${API_BASE_URL}/estabelecimentos/${id}`, { method:'DELETE' });
      if (resp.ok) {
        exibirMensagem('Excluído com sucesso!');
        carrega_estabelecimentos();
      } else {
        exibirMensagem('Erro ao excluir.', 'danger');
      }
    }

    function abrirEdicao(id) {
      // aqui você pode implementar o preenche-form para edição
      exibirMensagem('Edição em construção…', 'warning');
    }

    window.addEventListener('DOMContentLoaded', carrega_estabelecimentos);
  </script>
</body>
</html>
